{% extends "TicketBundle:Default:ticket.html.twig" %}

{% block content %}

    <ol class="breadcrumb">
      <li><a href="{{ path('user_index') }}">Home</a></li>
      <li class="active">List of Tickets</li>
    </ol>

    <div class="tblContainer">
        <a class="btn btn-primary " id="newTicket" href="{{ path('newTicket') }}"> New Ticket </a>

    <div style="height: 200px;">
        <div class="colFilter">

            {# Busca un ticket #}

            <form action="{{ path('listTicket') }}" id="contact" class="form" role="form" method="post">
                <div class="margined form-group">

                    <h5><b>Search by:</b></h5>
                    {% include 'TicketBundle:Default:includes/_filters_ticket.html.twig' %}

                    <button id="btn_search" class="btn btn-primary pull-right" type="submit"> Search </button>
                </div>
            </form>
        </div>
        <div class="colTickets">
            {# Si encuentra un ticket #}
            <table class="table table-hover">
                {% if tickets | length > 0 %}
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ticket Title</th>
                            <th>Status</th>
                            <th>Workshop</th>
                            <th>Assigned To</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for ticket in tickets %}
                        <tr>
                            <td>{{ ticket.id }}</td>
                            <td>{{ ticket.title | length > 10 ?  ticket.title | slice(0, 10) ~ '...' : ticket.title }}</td>
                            <td>{{ ticket.status }}</td>
                            <td>{{ ticket.workshop }}</td>
                            <td>{{ ticket.assignedTo }}</td>
                            <td>
                                {% if (ticket.owner.id == app.security.getToken().getUser().getId()) or is_granted('ROLE_ASSESSOR') %}
                                    <a href="{{ path('showTicket', { 'id_ticket' : ticket.id }) }}">
                                    <span class="glyphicon glyphicon-eye-open"></span></a>
                                {% endif %}
                              {% include 'TicketBundle:Default:includes/_assign_btn.html.twig' %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                {% else %}
                    <p> The Ticket you have requested is not avaliable </p>
                {% endif %}
            </table>
        </div>
    </div>

{# Muestra una lista de tickets sin responder #}
    <div>
        {% for ticket in tickets %}
            {# Comprueba que el usuario pueda ver ese ticket y que el ultimo post no sea del usuario #}
            {% set user = app.security.getToken().getUser() %}
            {% set lastPost = ticket.posts | length -1 %}
            {# Si : coinciden (talleres de usuario y ticket o ticket asignado a un asesor)
               Y  : el ultimo en responder != usuario logueado
            #}
            {% if ( ticket.owner == user   or   ticket.assignedTo == user )
               and  ticket.posts[lastPost].owner.id != user.getId() %}

               <p> <label>Ticket #{{ ticket.id }}                          </label>    Pending reply..
                   <a href="{{ path('showTicket', { 'id_ticket' : ticket.id }) }}">    Show            </a></p>

            {% endif %}
        {% endfor %}
    </div>
</div>
{% endblock %}