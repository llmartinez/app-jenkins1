{% extends "TicketBundle:Default:ticket.html.twig" %}

{% block content %}

    <h3>Tickets <a class="btn btn-primary " href="{{ path('newTicket') }}"> New Ticket </a></h3>
    
    <div class="tblContainer">
        
    <div style="height: 200px;">   
        <div class="colList">

            {# Busca un ticket #}
            <form action="{{ path('listTicket') }}" id="contact" class="form" role="form" method="post">
                <div class="col-xs-6 col-md-6 form-group">

                    <label>Search by</label>
                    <br>ID: <input type='text' id='id_ticket' name='id_ticket'>
                    <br><button class="btn btn-primary pull-right" type="submit"> Submit </button>
                </div>
            </form>
        </div>     
        <div class="colList">
            {# Si encuentra un ticket #}
            <table class="table table-striped table-bordered">
                <tr><td>
                    {% if ticket is not null%}
                        {% if ticket.id is not null %}
                            {% if (ticket.owner.id == app.security.getToken().getUser().getId()) or is_granted('ROLE_ADMIN') %}
                                
                                    <a class="btn btn-primary pull-right"  href="{{ path('showTicket', { 'id_ticket' : ticket.id }) }}"> View </a> 
                                
                                    <p> <label>Title:        </label> {{ ticket.title | length > 100 ?  ticket.title | slice(0, 100) ~ '...' : ticket.title }} </p>

                                    <p> <label>Date:         </label> {{ ticket.createdAt | date("d-m-Y") }}  ( {{ ticket.status }} ) </p>

                                    <p> <label>Workshop:     </label> {{ ticket.workshop }}         </p>
                                    
                                    <p> <label>Required by:  </label> {{ ticket.owner    }}         </p>

                                    <p> <label>Car:          </label> {{ ticket.car.version.model.brand }} 
                                                                      {{ ticket.car.version.model }} 
                                                                      {{ ticket.car.version }} 
                                                                     ({{ ticket.car.year }})        </p>
                                    <p> <label>PlateNumber:  </label> {{ ticket.car.plateNumber  }} -- 
                                        <label>VIN:          </label> {{ ticket.car.vin          }} </p>
                                    </p> 

                            {% else %}
                                <p> You don't have access to this ticket </p>
                            {% endif %}
                        {% endif %}                    
                    {% else %}
                        <p> The Ticket you have requested does not exist </p> 
                    {% endif %}
                </td></tr>
            </table>
        </div> 
    </div>
        
{# Muestra una lista de tickets sin responder #}
    <div>
        {% for ticket in tickets %}
        
            {# Comprueba que el usuario pueda ver ese ticket #}
            {% if (ticket.workshop.id == app.security.getToken().getUser().getWorkshop().getId()) or is_granted('ROLE_ADMIN') %}
        
                {# Comprueba que el ultimo post no sea del usuario #}
                {% if lastPosts[ticket.id].owner.id != app.security.getToken().getUser().getId() %}
        
                    <p> <label>Ticket #{{ ticket.id }}                          </label>    Pending reply..
                        <a href="{{ path('showTicket', { 'id_ticket' : ticket.id }) }}">    Show            </a></p>
                    
                {% endif %}   
            {% endif %}
        {% endfor %}
    </div>           
</div>    
{% endblock %}