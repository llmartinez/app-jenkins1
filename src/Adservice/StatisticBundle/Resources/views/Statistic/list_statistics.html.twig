{% extends '::layout.html.twig' %}
{% if app.security.getToken().getUser().getCategoryService().getId() is defined %}
    {% set id_catserv = app.security.getToken().getUser().getCategoryService().getId() %}
{% else %} 
    {% set id_catserv = '0' %}
{% endif %}
{% block body %}
    <ol class="breadcrumb">
        <li><a href="{{ path('user_index') }}">{{ 'home'|trans }}</a></li>
        <li class="active"> {{ 'menu.list_statistics'|trans }} </li>
    </ol>

<div>
{# FILTROS GENERALES #}
    <div class="col-xs-5 col-md-5 form-group">
        <legend>{{ 'filter_general'|trans }}</legend>
        <div class="col-xs-12 col-md-12 form-group">
            <table style="margin: 0 auto;">
            <tr>
                <td><label> {{ 'date.start'|trans }} </label></td>
                <td><label style="margin-left: 30px;"> {{ 'date.end'|trans }} </label></td>
            </tr>
            <tr><td>
                <input id="from_d" type="number" {% if from_d != '0' %} value="{{ from_d | date ('d')}}" {% endif %} class='form-control w25 fl' style="padding: 5px 0 5px 5px;">
                <input id="from_m" type="number" {% if from_m != '0' %} value="{{ from_m | date ('m')}}" {% endif %} class='form-control w25 fl' style="padding: 5px 0 5px 5px;">
                <input id="from_y" type="number" {% if from_y != '0' %} value="{{ from_y | date ('Y')}}" {% endif %} class='form-control' style="width: 41%;float: left;">
            </td>
            <td>
                <input id="to_d"   type="number" {% if to_d   != '0' %} value="{{ to_d   | date ('d')}}" {% endif %} class='form-control w25 fl' style="padding: 5px 0 5px 5px;  margin-left: 8%;">
                <input id="to_m"   type="number" {% if to_m   != '0' %} value="{{ to_m   | date ('m')}}" {% endif %} class='form-control w25 fl' style="padding: 5px 0 5px 5px;">
                <input id="to_y"   type="number" {% if to_y   != '0' %} value="{{ to_y   | date ('Y')}}" {% endif %} class='form-control' style="width: 42%;float: left;">
            </td></tr>
            </table>
        </div>
        <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'category_service'|trans }}</label>
           {% if is_granted('ROLE_SUPER_ADMIN') %}
                    <select id="flt_catserv" name="flt_category_service_statistics" class='form-control'>
                    <option value="0">{{ 'all'|trans }}</option>
                        {% for catserv in catservices %}
                            <option value="{{ catserv.id }}">{{ catserv }}</option>
                        {% endfor %}
                     </select>
                   {% else %}
                        <select disabled id="flt_catserv" name="flt_category_service_statistics" class='form-control'>
                            <option value="{{category_service.id}}">{{category_service.CategoryService}}</option>
                        </select>
                {% endif %}
        </div>
        <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'partner'|trans }}</label>
            <select id="flt_partner" name="flt_partner" class='form-control'>
                    <option value="0">{{ 'all'|trans }}</option>
                {% for partner in partners %}
                    <option value="{{ partner.id }}">{{ partner }}</option>
                {% endfor %}
            </select>
        </div>
        {% if is_granted('ROLE_SUPER_ADMIN') %}
        <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'country'|trans }}</label>
            <select id="flt_country" class='form-control'>
                <option value="0">{{ 'all'|trans }}</option>
                {% for country in countries %}
                    <option value="{{ country.id }}">{{ country | trans }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'raport'|trans }}</label>
            <select id="flt_raport" class='form-control'>

                <option value="0"                             >{{ 'any'|trans }}</option>
                
                {# Facturación ADService #}
                <option value="billing"                       >{{ 'billing'|trans }}</option>

                <option value="historical"                    >{{ 'historical'|trans }}</option>

                {# Talleres sin tickets #}
                <option value="no-ticket"                     >{{ 'statistic.no_ticket'|trans }}</option>

                {# Últimos tickets de los talleres #}
                <option value="last-tickets"                  >{{ 'statistic.last_tickets'|trans }}</option>

                {# TOP TEN de talleres por socio #}
                <option value="numworkshopbypartner"          >{{ 'numworkshopbypartner'|trans }}</option>

                {# TOP TEN de tickets de talleres por socio #}
                <option value="ticketbyworkshopforpartner"    >{{ 'ticketbyworkshopforpartner'|trans }}</option>

                {# TOP TEN de tickets por socio #}
                <option value="numticketsbypartner"           >{{ 'numticketsbypartner'|trans }}</option>

                {# TOP TEN de tickets por sistema/subsistema #}
                <option value="numticketsbysystem"            >{{ 'numticketsbysystem'|trans }}</option>

                {# TOP TEN de tickets por marca #}
                <option value="numticketsbybrand"             >{{ 'numticketsbybrand'|trans }}</option>

                {# TOP TEN de tickets por modelo #}
                <option value="numticketsbymodel"             >{{ 'numticketsbymodel'|trans }}</option>

                {# TOP TEN de tickets por año de fabricacion #}
                <option value="numticketsbyfabyear"           >{{ 'numticketsbyfabyear'|trans }}</option>
             </select>
        </div>
    </div>

    <div class="col-xs-7 col-md-7 form-group">
{# FILTROS DE TICKET #}
        <div class="col-xs-6 col-md-6 form-group">
            <legend>{{ 'filter_ticket'|trans }}</legend>
            <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'workshop'|trans }}</label>
                <select id="flt_tck_workshop" class='form-control'>
                        <option value="0">{{ 'all'|trans }}</option>
                     {% for workshop in workshops %}
                        <option value="{{ workshop.id }}">{{ workshop.codePartner }}-{{ workshop.codeWorkshop }}: {{ workshop.name|length > 15 ? workshop.name|slice(0, 15) ~ '...' : workshop.name  }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'status'|trans }}</label>
                <select id="flt_tck_status" class='form-control'>
                    <option value="0"         >{{ 'all'|trans }}</option>
                    <option value="open"      >{{ 'open'|trans }}</option>
                    <option value="closed"    >{{ 'closed'|trans }}</option>
                    <option value="inactive"  >{{ 'inactive'|trans }}</option>
                    <option value="expirated" >{{ 'expirated'|trans }}</option>
                 </select>
             </div>
            <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'assessor'|trans }}</label>
                <select id="flt_tck_assessor" class='form-control'>
                    <option value="0">{{ 'all'|trans }}</option>
                    {% for assessor in assessors %}
                        <option value="{{ assessor.id }}">{{ assessor.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'created_by'|trans }}</label>
                <select id="flt_tck_created_by" class='form-control'>
                    <option value="0">  {{ 'all'|trans }}</option>
                    <option value="tel">{{ 'tel'|trans }}</option>
                    <option value="app">{{ 'ticket'|trans }}</option>
                </select>
            </div>
            <div class="col-xs-12 col-md-12 form-group">
                <button class="btn btn-primary btn100" id="btn_search_ticket" style="margin-top: 4px;">
                    <img class="img_icon" src="{{ asset('bundles/util/images/icon/download.png') }}"> {{ 'generate.ticket'|trans }}</button>
            </div>
        </div>

{# FILTROS DE TALLER #}
        <div class="col-xs-6 col-md-6 form-group">
        <legend>{{ 'filter_workshop'|trans }}</legend>
            {% if id_catserv != 3 %}
                <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'shop'|trans }}</label>
                    <input type="hidden" id="lbl_all" value="{{ 'all'|trans }}">
                    <select id="flt_wks_shop" class='form-control'>
                            <option value="0">{{ 'all'|trans }}</option>
                        {% for shop in shops %}
                            <option value="{{ shop.id }}">{{ shop }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
            <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'typology'|trans }}</label>
                <select id="flt_wks_typology" class='form-control'>
                        <option value="0">{{ 'all'|trans }}</option>
                    {% for typology in typologies %}
                        <option value="{{ typology.id }}">{{ typology }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-xs-6 col-md-6 form-group"> <label> {{ 'status'|trans }}</label>
                <select id="flt_wks_status" class='form-control'>
                    <option value="all"     >{{ 'all'|trans }}</option>
                    <option value="active"  >{{ 'active'|trans }}</option>
                    <option value="deactive">{{ 'inactive'|trans }}</option>
                    <option value="test"    >{{ 'testing'|trans }}</option>
                    <option value="adsplus" >{{ 'adsplus'|trans }}</option>
                    <option value="check"   >{{ 'haschecks'|trans }}</option>
                    <option value="infotech">{{ 'infotech'|trans }}</option>
                    {# <option value="noticket">Without Tickets</option> #}
                 </select>
             </div>
            <div class="col-xs-12 col-md-12 form-group">
                <button class="btn btn-primary btn100" id="btn_search_workshop" style="margin-top: 4px;">
                    <img class="img_icon" src="{{ asset('bundles/util/images/icon/download.png') }}"> {{ 'generate.workshop'|trans }}</button>
            </div>
            {% if is_granted('ROLE_SUPER_ADMIN') %}
                <div class="col-xs-12 col-md-12 form-group">
                    <button class="btn btn-primary btn100" id="btn_search_partner" style="margin-top: 4px;">
                        <img class="img_icon" src="{{ asset('bundles/util/images/icon/download.png') }}"> {{ 'generate.partner'|trans }}</button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div>

    {% if statistic.results is defined %}

        {% if type == 'ticket' %}

            <legend id="statistics_legend" data-type="ticket"> {{ 'statistic.tickets'|trans }}
                {% if is_granted('ROLE_SUPER_ADMIN')  %} {{ 'statistic.from_adservice'|trans }}
                {% else %}                               {{ 'statistic.from_country'|trans }}
                {% endif %}
                ({{ length }})
                <img id="doExcel_ticket" class="img_icon pull-right" src="{{ asset('bundles/util/images/icon/export_excel.png') }}" title="{{ 'statistics.download'|trans }}">
            </legend>

            <table class="table table-hover table-list-search">
                <thead>
                    <tr>
                        <th> #           </th>
                        <th>{{ 'car'|trans }}</th>
                        <th>{{ 'ticket.assigned_to'|trans }}</th>
                        <th>{{ 'description'|trans }}</th>
                        <th>{{ 'status'|trans }}</th>
                        <th>                                             </th>
                        <th>{{ 'date'|trans }}</th>
                    </tr>
                </thead>
                <tbody id="ticketBody">
                    {% for ticket in statistic.results %}
                        <tr id="ticketRow">
                            <td id="id_ticket">{{ ticket.id         }}</td>
                            {% set car = ticket.car.brand ~ ' ' ~ ticket.car.model %}<td title="{{car}}"> {{ car|length > 15 ? car|slice(0, 15) ~ '...' : car  }}</td>
                            <td>{{ ticket.assignedTo                }}</td>
                            <td title="{{ticket.description}}">   {{ ticket.description|length > 25 ? ticket.description|slice(0, 25) ~ '...' : ticket.description }}</td>
                            <td>{{ ticket.status | trans            }}</td>
                            <td><a href="{{ path('showTicket', {'id': ticket.id}) }}" title="{{ 'ticket.show'|trans }}"><img class="img_icon" src="{{ asset('bundles/util/images/icon/ticket_show.png') }}"></a></td>
                            <td>{{ ticket.createdAt | date("d/m/y") }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="col-xs-12 col-md-12 form-group">{% include 'UtilBundle:Pagination:pagination_statistic.html.twig' %}</div>

        {% elseif type == 'workshop' %}

            <legend id="statistics_legend" data-type="workshops"> {{ 'statistic.workshops'|trans }}
                {% if is_granted('ROLE_SUPER_ADMIN')  %} {{ 'statistic.from_adservice'|trans }}
                {% else %}                               {{ 'statistic.from_country'|trans }}
                {% endif %}
                ({{ length }})
               <img id="doExcel_workshop" class="img_icon pull-right" src="{{ asset('bundles/util/images/icon/export_excel.png') }}" title="{{ 'statistics.download'|trans }}">
            </legend>

            <table class="table table-hover table-list-search">
                <thead>
                    <tr>
                        <th>{{ 'code'|trans }}</th>
                        <th>{{ 'workshop'|trans }}</th>
                        <th>{{ 'partner'|trans }}</th>
                        <th>{{ 'email'|trans }}</th>
                        <th>{{ 'tel'|trans }}</th>
                    </tr>
                </thead>
                <tbody>
                        {% for workshop in statistic.results %}
                    <tr>
                        <td>{{ workshop.partner.codePartner }} - {{ workshop.codeWorkshop }}</td>
                        <td>{{ workshop.name|length > 15 ? workshop.name|slice(0, 15) ~ '...' : workshop.name  }}
                            {% if workshop.active == false %}<span class="label label-danger">{{ 'inactive'|trans }}</span>{% endif %}</td>
                        <td>{{ workshop.partner}}</td>
                        <td>{{ workshop.email1 }}</td>
                        <td>{{ workshop.phoneNumber1 }}</td>
                    </tr>
                        {% endfor %}
                </tbody>
            </table>

            <div class="col-xs-12 col-md-12 form-group">{% include 'UtilBundle:Pagination:pagination_statistic.html.twig' %}</div>

        {% elseif type == 'no-ticket' %}

            <legend> {{ 'statistic.general'|trans }}

            {% if is_granted('ROLE_SUPER_ADMIN')  %} {{ 'statistic.from_adservice'|trans }}
            {% else %}                               {{ 'statistic.from_country'|trans }}
            {% endif %}</legend>

            <legend> {{ 'statistic.no_ticket'|trans }} ({{ length }}) -- <button class="btn btn-primary" id="btn_search_last_ticket" >
                <img class="img_icon" src="{{ asset('bundles/util/images/icon/search_btn.png') }}"> {{ 'statistic.last_tickets'|trans }}</button></a>
                <img id="doExcel_no_ticket" class="img_icon pull-right" src="{{ asset('bundles/util/images/icon/export_excel.png') }}" title="{{ 'statistics.download'|trans }}">
            </legend>

            <table class="table table-hover table-list-search">
                <thead>
                    <tr>
                        <th>{{ 'code'|trans }}</th>
                        <th>{{ 'workshop'|trans }}</th>
                        <th>{{ 'partner'|trans }}</th>
                        <th>{{ 'created_at'|trans }}</th>
                    </tr>
                </thead>
                <tbody>
                        {% for workshop in statistic.results %}
                    <tr>
                        <td>{{ workshop.partner.codePartner }} - {{ workshop.codeWorkshop }}</td>
                        <td>{{ workshop.name|length > 25 ? workshop.name|slice(0, 25) ~ '...' : workshop.name }}
                            {% if workshop.active == false %}<span class="label label-danger">{{ 'inactive'|trans }}</span>{% endif %}
                        </td>
                        <td title="{{workshop.partner}}">
                            {{ workshop.partner|length > 25 ? workshop.partner|slice(0, 25) ~ '...' : workshop.partner }}
                        </td>
                        <td>{{ workshop.createdAt | date("d/m/y") }}</td>
                    </tr>
                        {% endfor %}
                </tbody>
            </table>

            <div class="col-xs-12 col-md-12 form-group">{% include 'UtilBundle:Pagination:pagination_statistic.html.twig' %}</div>

        {% elseif type == 'last-tickets' %}

            <legend> {{ 'statistic.general'|trans }}

            {% if is_granted('ROLE_SUPER_ADMIN')  %} {{ 'statistic.from_adservice'|trans }}
            {% else %}                               {{ 'statistic.from_country'|trans }}
            {% endif %}</legend>

            <legend> {{ 'statistic.last_tickets'|trans }} ({{ length }}) -- <button class="btn btn-primary" id="btn_search_no_ticket" >
                <img class="img_icon" src="{{ asset('bundles/util/images/icon/search_btn.png') }}"> {{ 'statistic.no_ticket'|trans }}</button></a>
                <img id="doExcel_last_ticket" class="img_icon pull-right" src="{{ asset('bundles/util/images/icon/export_excel.png') }}" title="{{ 'statistics.download'|trans }}">
            </legend>

            <table class="table table-hover table-list-search">
                <thead>
                    <tr>
                        <th>{{ 'code'|trans }}</th>
                        <th>{{ 'workshop'|trans }}</th>
                        <th>{{ 'partner'|trans }}</th>
                        <th>{{ 'ticket'|trans }}</th>
                        <th>{{ 'status'|trans }}</th>
                        <th>                                   </th>
                        <th>{{ 'date'|trans }}</th>
                    </tr>
                </thead>
                <tbody>
                        {% for ticket in statistic.results %}
                    <tr>
                        <td>{{ ticket.workshop.partner.codePartner }} - {{ ticket.workshop.codeWorkshop }}</td>
                        <td>{{ ticket.workshop.name|length > 25 ? ticket.workshop.name|slice(0, 25) ~ '...' : ticket.workshop.name }}
                            {% if ticket.workshop.active == false %}<span class="label label-danger">{{ 'inactive'|trans }}</span>{% endif %}
                        </td>
                        <td title="{{ticket.workshop.partner}}">
                            {{ ticket.workshop.partner|length > 25 ? ticket.workshop.partner|slice(0, 25) ~ '...' : ticket.workshop.partner }}
                        </td>
                        <td title="{{ticket.description}}">   {{ ticket.description|length > 25 ? ticket.description|slice(0, 25) ~ '...' : ticket.description }}</td>
                        <td>{{ ticket.status | trans            }}</td>
                        <td><a href="{{ path('showTicket', {'id': ticket.id}) }}" title="{{ 'ticket.show'|trans }}"><img class="img_icon" src="{{ asset('bundles/util/images/icon/ticket_show.png') }}"></a></td>
                        <td>{{ ticket.createdAt | date("d/m/y") }}</td>
                    </tr>
                        {% endfor %}
                </tbody>
            </table>

            <div class="col-xs-12 col-md-12 form-group">{% include 'UtilBundle:Pagination:pagination_statistic.html.twig' %}</div>

        {% else %}
            <legend> {{ 'statistic.general'|trans }}

            {% if is_granted('ROLE_SUPER_ADMIN')  %} {{ 'statistic.from_adservice'|trans }}
            {% else %}                               {{ 'statistic.from_country'|trans }}
            {% endif %}</legend>

            <div class="col-xs-12 col-md-12 form-group">
                <div class="col-xs-3 col-md-3 form-group"> <label>{{ 'statistic.num_users'|trans }}</label></div>
                <div class="col-xs-1 col-md-1 form-group">                 {{ statistic.getNumUsers         }}            </div>
                <div class="col-xs-3 col-md-3 form-group"> <label>{{ 'statistic.num_workshops'|trans }}</label></div>
                <div class="col-xs-1 col-md-1 form-group">                 {{ statistic.getNumWorkshops     }}            </div>
                <div class="col-xs-3 col-md-3 form-group"> <label>{{ 'statistic.num_tickets'|trans }}</label></div>
                <div class="col-xs-1 col-md-1 form-group">                 {{ statistic.getNumTickets       }}            </div>

                <div class="col-xs-3 col-md-3 form-group"> <label>{{ 'statistic.num_partners'|trans }}</label></div>
                <div class="col-xs-1 col-md-1 form-group">                 {{ statistic.getNumPartners      }}            </div>
                <div class="col-xs-3 col-md-3 form-group"> <label>{{ 'statistic.num_tickets.open'|trans }}</label></div>
                <div class="col-xs-1 col-md-1 form-group">                 {{ statistic.getNumOpenTickets   }}            </div>
                <div class="col-xs-3 col-md-3 form-group"> <label>{{ 'statistic.num_tickets_tel'|trans }}</label></div>
                <div class="col-xs-1 col-md-1 form-group">                 {{ statistic.getNumTicketsTel    }}            </div>

                <div class="col-xs-3 col-md-3 form-group"> <label>{{ 'statistic.num_shops'|trans }}</label></div>
                <div class="col-xs-1 col-md-1 form-group">                 {{ statistic.getNumShops         }}            </div>
                <div class="col-xs-3 col-md-3 form-group"> <label>{{ 'statistic.num_tickets.closed'|trans }}</label></div>
                <div class="col-xs-1 col-md-1 form-group">                 {{ statistic.getNumClosedTickets }}            </div>
                <div class="col-xs-3 col-md-3 form-group"> <label>{{ 'statistic.num_tickets_app'|trans }}</label></div>
                <div class="col-xs-1 col-md-1 form-group">                 {{ statistic.getNumTicketsApp    }}            </div>
            </div>
        {% endif %}

    {% endif %}

</div>
    <input type="hidden" id="type"            value="{{ type      }}">
    <input type="hidden" id="type_from_y"     value="{{ from_y    }}">
    <input type="hidden" id="type_from_m"     value="{{ from_m    }}">
    <input type="hidden" id="type_from_d"     value="{{ from_d    }}">
    <input type="hidden" id="type_to_y"       value="{{ to_y      }}">
    <input type="hidden" id="type_to_m"       value="{{ to_m      }}">
    <input type="hidden" id="type_to_d"       value="{{ to_d      }}">
    <input type="hidden" id="type_status"     value="{{ status    }}">
    <input type="hidden" id="type_partner"    value="{{ partner   }}">
    <input type="hidden" id="type_shop"       value="{{ shop      }}">
    <input type="hidden" id="type_workshop"   value="{{ wks       }}">
    <input type="hidden" id="type_assessor"   value="{{ assessor  }}">
    <input type="hidden" id="type_created_by" value="{{ created_by}}">
    <input type="hidden" id="type_typology"   value="{{ typology  }}">
    <input type="hidden" id="type_country"    value="{{ country   }}">
    <input type="hidden" id="type_status"     value="{{ status    }}">

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/statistic/js/statistic.js') }}"></script>
    <script src="{{ asset('bundles/util/js/pagination_statistic.js') }}"></script>
    <script src="{{ asset('bundles/util/js/catserv.js') }}"></script>
{% endblock %}
